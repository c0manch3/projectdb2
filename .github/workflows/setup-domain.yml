name: Setup Domain & SSL

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain name'
        required: true
        default: 'lencondb.ru'
      email:
        description: 'Email for SSL certificate'
        required: true
        default: 'admin@lencondb.ru'

env:
  SERVER_HOST: 45.131.42.199
  SERVER_USER: root
  APP_DIR: /opt/projectdb2

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Install nginx and certbot
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "apt-get update && apt-get install -y nginx certbot python3-certbot-nginx"

      - name: Create certbot webroot
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p /var/www/certbot"

      - name: Create temporary nginx config
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cat > /etc/nginx/sites-available/${{ inputs.domain }} << 'EOF'
          server {
              listen 80;
              server_name ${{ inputs.domain }} www.${{ inputs.domain }};

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }

              location / {
                  return 200 'Setting up SSL...';
                  add_header Content-Type text/plain;
              }
          }
          EOF"

      - name: Enable site and start nginx
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "ln -sf /etc/nginx/sites-available/${{ inputs.domain }} /etc/nginx/sites-enabled/ && rm -f /etc/nginx/sites-enabled/default && nginx -t && systemctl enable nginx && systemctl restart nginx"

      - name: Obtain SSL certificate
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "certbot certonly --webroot -w /var/www/certbot -d ${{ inputs.domain }} -d www.${{ inputs.domain }} --email ${{ inputs.email }} --agree-tos --non-interactive"

      - name: Apply full nginx config with SSL
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cat > /etc/nginx/sites-available/${{ inputs.domain }} << 'EOF'
          server {
              listen 80;
              server_name ${{ inputs.domain }} www.${{ inputs.domain }};

              location / {
                  return 301 https://\$server_name\$request_uri;
              }

              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
          }

          server {
              listen 443 ssl http2;
              server_name ${{ inputs.domain }} www.${{ inputs.domain }};

              ssl_certificate /etc/letsencrypt/live/${{ inputs.domain }}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${{ inputs.domain }}/privkey.pem;

              ssl_session_timeout 1d;
              ssl_session_cache shared:SSL:50m;
              ssl_session_tickets off;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
              ssl_prefer_server_ciphers off;

              add_header Strict-Transport-Security \"max-age=63072000\" always;

              location /api {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_cache_bypass \$http_upgrade;
                  proxy_read_timeout 86400;
              }

              location /socket.io {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection \"upgrade\";
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_read_timeout 86400;
              }

              location / {
                  proxy_pass http://127.0.0.1:8080;
                  proxy_http_version 1.1;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }

              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_proxied any;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;
          }
          EOF"

      - name: Reload nginx with SSL config
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "nginx -t && systemctl restart nginx"

      - name: Enable certificate auto-renewal
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "systemctl enable certbot.timer && systemctl start certbot.timer"

      - name: Verify setup
        run: |
          echo "Setup complete!"
          echo "Domain: https://${{ inputs.domain }}"
          echo ""
          echo "Next: Run 'Deploy to Production' workflow to deploy the app"
